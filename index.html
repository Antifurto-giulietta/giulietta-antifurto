<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Giulietta Antifurto – Tracking</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    body { margin:0; font-family: system-ui, Arial; }
    #top { padding:12px; display:grid; gap:8px; }
    .grid { display:grid; grid-template-columns: repeat(2,1fr); gap:8px; }
    .card { padding:10px; border:1px solid #ddd; border-radius:10px; }
    #map { height: 70vh; }
    .mono { font-family: ui-monospace, Menlo, monospace; }
  </style>
</head>
<body>

<div id="top">
  <div class="grid">
    <div class="card">Device<br><b class="mono">Giulietta_Antifurto</b></div>
    <div class="card">Ultimo aggiornamento<br><b class="mono" id="last">-</b></div>
    <div class="card">Pompa<br><b class="mono" id="pump">-</b></div>
    <div class="card">Allarme<br><b class="mono" id="alarm">-</b></div>
    <div class="card">Tracking<br><b class="mono" id="tracking">-</b></div>
    <div class="card">Velocità<br><b class="mono" id="speed">-</b></div>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const deviceId = "Giulietta_Antifurto";

  // >>> SOSTITUISCI QUESTO BLOCCO <<<
  <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBMOjoYPuHQVX3JjRywVDyp1wOpmbHpPV8",
  authDomain: "giuliettaantifurto.firebaseapp.com",
  projectId: "giuliettaantifurto",
  storageBucket: "giuliettaantifurto.firebasestorage.app",
  messagingSenderId: "800289759238",
  appId: "1:800289759238:web:5e975dac11b7a34a542387"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>
  // >>> FINE <<<

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const map = L.map('map').setView([40.85, 14.25], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let marker = L.marker([40.85,14.25]).addTo(map);
  let poly = L.polyline([], { weight:4 }).addTo(map);

  const elLast = document.getElementById("last");
  const elPump = document.getElementById("pump");
  const elAlarm = document.getElementById("alarm");
  const elTracking = document.getElementById("tracking");
  const elSpeed = document.getElementById("speed");

  function fmt(ts){
    if(!ts) return "-";
    return new Date(ts*1000).toLocaleString("it-IT");
  }

  const devRef = doc(db, "devices", deviceId);
  onSnapshot(devRef, snap => {
    if(!snap.exists()) return;
    const d = snap.data();
    elLast.textContent = fmt(d.ts);
    elPump.textContent = d.pump ? "ON" : "OFF";
    elAlarm.textContent = d.alarm ? "ATTIVO" : "NO";
    elTracking.textContent = d.tracking ? "ON" : "OFF";
    elSpeed.textContent = (d.speed ?? 0).toFixed(1) + " km/h";

    if(typeof d.lat === "number" && typeof d.lon === "number"){
      marker.setLatLng([d.lat,d.lon]);
      map.setView([d.lat,d.lon],16);
    }
  });

  async function loadTrace(){
    const q = query(
      collection(db,"devices",deviceId,"track"),
      orderBy("ts","desc"),
      limit(600)
    );
    const s = await getDocs(q);
    const pts=[];
    s.forEach(doc=>{
      const p=doc.data();
      if(typeof p.lat==="number") pts.push([p.lat,p.lon]);
    });
    pts.reverse();
    poly.setLatLngs(pts);
  }

  loadTrace();
  setInterval(loadTrace,10000);
</script>
</body>
</html>
